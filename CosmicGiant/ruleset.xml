<?xml version="1.0"?>
<ruleset name="CosmicGiant">
    <description>CosmicGiant Coding standards for Laravel</description>

    <!-- Check for cross-version support for PHP 8.4 and higher. -->
    <config name="testVersion" value="8.4-"/>

    <!-- Only scan PHP files. -->
    <arg name="extensions" value="php"/>

    <!-- Whenever possible, cache the scan results and re-use those for unchanged files on the next scan. -->
    <arg name="cache"/>

    <!-- Set the memory limit to 256M.
         For most standard PHP configurations, this means the memory limit will temporarily be raised.
         Ref: https://github.com/squizlabs/PHP_CodeSniffer/wiki/Advanced-Usage#specifying-phpini-settings
    -->
    <ini name="memory_limit" value="256M"/>

    <!-- Check up to 20 files simultaneously. -->
    <arg name="parallel" value="20"/>

    <!-- Show sniff codes in all reports. -->
    <arg value="ps"/>

    <!-- Exclude patterns -->
    <exclude-pattern>/node_modules/*</exclude-pattern>
    <exclude-pattern>/vendor/*</exclude-pattern>
    <exclude-pattern>/tmp</exclude-pattern>
    <exclude-pattern>/storage/*</exclude-pattern>
    <exclude-pattern>/bootstrap/cache/*</exclude-pattern>
    <!-- We may want to include tests later. -->
    <exclude-pattern>/tests/*</exclude-pattern>

    <!-- ==================== -->
    <!-- Base PSR-12 Standard -->
    <!-- ==================== -->
    <rule ref="PSR12">
        <!-- We allow inline control structures for simple one-liners -->
        <exclude name="Generic.ControlStructures.InlineControlStructure.NotAllowed"/>

        <!-- Exclude PSR-12 brace placement rules - we use K&R style (same line) -->
        <exclude name="Squiz.Classes.ClassDeclaration.OpenBraceNewLine"/>
        <exclude name="Squiz.Functions.MultiLineFunctionDeclaration.BraceOnSameLine"/>
        <exclude name="PSR2.Classes.ClassDeclaration.OpenBraceNewLine"/>
        <exclude name="Squiz.Functions.MultiLineFunctionDeclaration.OpenBraceNewLine"/>

        <!-- Exclude PSR-12 no-space-in-parentheses rules - we require spaces -->
        <exclude name="PSR2.Methods.FunctionCallSignature.SpaceAfterOpenBracket"/>
        <exclude name="PSR2.Methods.FunctionCallSignature.SpaceBeforeCloseBracket"/>
        <exclude name="Squiz.Functions.FunctionDeclarationArgumentSpacing.SpacingAfterOpen"/>
        <exclude name="Squiz.Functions.FunctionDeclarationArgumentSpacing.SpacingBeforeClose"/>
        <exclude name="PSR2.ControlStructures.ControlStructureSpacing.SpacingAfterOpenBrace"/>
        <exclude name="PSR2.ControlStructures.ControlStructureSpacing.SpaceBeforeCloseBrace"/>
    </rule>

    <!-- ==================== -->
    <!-- Spaces Inside Parentheses -->
    <!-- ==================== -->
    <!-- Require spaces inside parentheses for function calls: func( $arg ) -->
    <rule ref="PEAR.Functions.FunctionCallSignature">
        <properties>
            <property name="requiredSpacesAfterOpen" value="1"/>
            <property name="requiredSpacesBeforeClose" value="1"/>
        </properties>
    </rule>

    <!-- Require spaces inside parentheses for function declarations -->
    <rule ref="Squiz.Functions.FunctionDeclarationArgumentSpacing">
        <properties>
            <property name="equalsSpacing" value="1"/>
            <property name="requiredSpacesAfterOpen" value="1"/>
            <property name="requiredSpacesBeforeClose" value="1"/>
        </properties>
    </rule>

    <!-- Require spaces inside control structure parentheses: if ( $condition ) -->
    <rule ref="WordPress.WhiteSpace.ControlStructureSpacing"/>

    <!-- ==================== -->
    <!-- Brace Placement (K&R Style - Same Line) -->
    <!-- ==================== -->
    <!-- Opening brace on same line for functions -->
    <rule ref="Generic.Functions.OpeningFunctionBraceKernighanRitchie">
        <properties>
            <property name="checkFunctions" value="true"/>
            <property name="checkClosures" value="true"/>
        </properties>
    </rule>

    <!-- Opening brace on same line for classes/interfaces/traits -->
    <rule ref="Generic.Classes.OpeningBraceSameLine"/>

    <!-- ==================== -->
    <!-- Class/Function Brace Spacing -->
    <!-- ==================== -->

    <!-- Enforce no blank lines at the start and end of classes. -->
    <rule ref="PSR2.Classes.ClassDeclaration.CloseBraceAfterBody"/>
    <rule ref="Squiz.WhiteSpace.ScopeClosingBrace"/>

    <!-- Enforce no blank lines at the start of a class/interface/trait body. -->
    <rule ref="SlevomatCodingStandard.Classes.ClassStructure">
        <properties>
            <property name="groups" type="array">
                <element value="uses"/>
                <element value="public constants"/>
                <element value="protected constants"/>
                <element value="private constants"/>
                <element value="public static properties"/>
                <element value="protected static properties"/>
                <element value="private static properties"/>
                <element value="public properties"/>
                <element value="protected properties"/>
                <element value="private properties"/>
                <element value="constructor"/>
                <element value="static constructors"/>
                <element value="public static methods"/>
                <element value="protected static methods"/>
                <element value="private static methods"/>
                <element value="public methods"/>
                <element value="protected methods"/>
                <element value="private methods"/>
                <element value="magic methods"/>
            </property>
        </properties>
    </rule>

    <!-- No blank line after class opening brace -->
    <rule ref="SlevomatCodingStandard.Classes.EmptyLinesAroundClassBraces">
        <properties>
            <property name="linesCountAfterOpeningBrace" value="0"/>
            <property name="linesCountBeforeClosingBrace" value="0"/>
        </properties>
    </rule>

    <!-- Enforce no blank lines at the start and end of functions. -->
    <rule ref="Squiz.WhiteSpace.FunctionOpeningBraceSpace"/>
    <rule ref="PSR2.Methods.FunctionClosingBrace.SpacingBeforeClose"/>

    <!-- ==================== -->
    <!-- Array Syntax -->
    <!-- ==================== -->
    <!-- Use short array syntax -->
    <rule ref="Generic.Arrays.DisallowLongArraySyntax"/>

    <!-- ==================== -->
    <!-- Control Structures -->
    <!-- ==================== -->
    <!-- Allow short ternary operator -->
    <!-- No exclusion needed - PSR-12 allows it -->

    <!-- Allow assignment in conditions (common in while loops, etc.) -->
    <rule ref="Generic.CodeAnalysis.AssignmentInCondition">
        <exclude name="Generic.CodeAnalysis.AssignmentInCondition.Found"/>
        <exclude name="Generic.CodeAnalysis.AssignmentInCondition.FoundInWhileCondition"/>
    </rule>

    <!-- We use extra lines for better readability, turn the following rules into warnings. -->
    <rule ref="PSR2.ControlStructures.SwitchDeclaration.BodyOnNextLineCASE">
        <type>warning</type>
    </rule>
    <rule ref="PSR2.ControlStructures.SwitchDeclaration.BodyOnNextLineDEFAULT">
        <type>warning</type>
    </rule>

    <!-- ==================== -->
    <!-- Coding Style Preferences -->
    <!-- ==================== -->

    <!-- Allow the use of: $a = $b = 1; -->
    <rule ref="Squiz.PHP.DisallowMultipleAssignments.FoundInControlStructure">
        <type>warning</type>
    </rule>
    <rule ref="Squiz.PHP.DisallowMultipleAssignments.Found">
        <type>warning</type>
    </rule>

    <!-- Check for empty PHP statements -->
    <rule ref="Generic.CodeAnalysis.EmptyPHPStatement"/>

    <!-- We like one-liners, turn the following rules into warnings. -->
    <rule ref="Generic.Functions.OpeningFunctionBraceKernighanRitchie.ContentAfterBrace">
        <type>warning</type>
    </rule>
    <rule ref="Generic.Formatting.DisallowMultipleStatements.SameLine">
        <type>warning</type>
    </rule>

    <!-- ==================== -->
    <!-- Naming Conventions -->
    <!-- ==================== -->
    <!-- Laravel uses camelCase for variables and methods, PascalCase for classes -->
    <!-- PSR-12 handles this by default -->

    <!-- ==================== -->
    <!-- PHP Compatibility -->
    <!-- ==================== -->
    <rule ref="PHPCompatibility"/>

    <!-- ==================== -->
    <!-- Variable Analysis -->
    <!-- ==================== -->
    <!-- Throw undefined variable errors https://github.com/sirbrillig/phpcs-variable-analysis -->
    <rule ref="VariableAnalysis"/>

    <!-- ==================== -->
    <!-- Import Detection -->
    <!-- ==================== -->
    <!-- Import Detection: https://github.com/sirbrillig/phpcs-import-detection -->
    <rule ref="ImportDetection"/>
    <rule ref="ImportDetection.Imports.RequireImports">
        <properties>
            <property name="ignoreUnimportedSymbols" value="/^(rg\S+|cg\S+|CG\S+|fg\S+|FG\S+)$/"/>
        </properties>
    </rule>

    <!-- ==================== -->
    <!-- Slevomat Rules -->
    <!-- ==================== -->
    <!-- Require trailing comma in multi-line arrays -->
    <rule ref="SlevomatCodingStandard.Arrays.TrailingArrayComma"/>

    <!-- Enforce type hints where possible -->
    <rule ref="SlevomatCodingStandard.TypeHints.ReturnTypeHint">
        <properties>
            <property name="enableStaticTypeHint" value="true"/>
            <property name="enableMixedTypeHint" value="true"/>
            <property name="enableUnionTypeHint" value="true"/>
            <property name="enableIntersectionTypeHint" value="true"/>
            <property name="enableNeverTypeHint" value="true"/>
        </properties>
        <exclude name="SlevomatCodingStandard.TypeHints.ReturnTypeHint.MissingTraversableTypeHintSpecification"/>
    </rule>

    <rule ref="SlevomatCodingStandard.TypeHints.ParameterTypeHint">
        <exclude name="SlevomatCodingStandard.TypeHints.ParameterTypeHint.MissingTraversableTypeHintSpecification"/>
    </rule>

    <rule ref="SlevomatCodingStandard.TypeHints.PropertyTypeHint">
        <exclude name="SlevomatCodingStandard.TypeHints.PropertyTypeHint.MissingTraversableTypeHintSpecification"/>
    </rule>

    <!-- Require use statements to be sorted -->
    <rule ref="SlevomatCodingStandard.Namespaces.AlphabeticallySortedUses"/>

    <!-- Require single blank line after namespace -->
    <rule ref="SlevomatCodingStandard.Namespaces.NamespaceSpacing">
        <properties>
            <property name="linesCountBeforeNamespace" value="1"/>
            <property name="linesCountAfterNamespace" value="1"/>
        </properties>
    </rule>

    <!-- Require blank line after use statements -->
    <rule ref="SlevomatCodingStandard.Namespaces.UseSpacing">
        <properties>
            <property name="linesCountBeforeFirstUse" value="1"/>
            <property name="linesCountBetweenUseTypes" value="1"/>
            <property name="linesCountAfterLastUse" value="1"/>
        </properties>
    </rule>

    <!-- Disallow unused use statements -->
    <rule ref="SlevomatCodingStandard.Namespaces.UnusedUses">
        <properties>
            <property name="searchAnnotations" value="true"/>
        </properties>
    </rule>

    <!-- Clean up unnecessary parentheses -->
    <rule ref="SlevomatCodingStandard.PHP.UselessParentheses"/>

    <!-- Require null-safe operator where applicable (PHP 8.0+) -->
    <rule ref="SlevomatCodingStandard.ControlStructures.RequireNullSafeObjectOperator"/>

</ruleset>
